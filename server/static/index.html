<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Main</title>
    <meta name="viewport" content="width=device-width">
    <style>html,head,body { padding:0; margin:0; } 
      body { font-family: mono, calibri, helvetica, arial, sans-serif; background-color:#EEEEEC; }</style>
    <script type="text/javascript" src="/static/main.js"></script>
    <script type="text/javascript" src="/static/localvals.js"></script>
    <script type="text/javascript" src="/static/windowkey.js"></script>
  </head>
  <body>
    <div id="elm"></div> 
    <script type="text/javascript">
      // all we'd use in a saner world.  textarea highlighted text is ok here with chrome.
      function getRegularSelectionText() {
          var text = "";
          if (window.getSelection) {
              console.log("focusOffset");
              console.log(window.getSelection().focusOffset);
              console.log("anchorOffset");
              console.log(window.getSelection().anchorOffset);
              console.log("getRangeAt(0)");
              console.log(window.getSelection().getRangeAt(0));
              console.log("window.getSelection");
              console.log(window.getSelection());
              
              text = window.getSelection().toString();
              // try getting focusOffset.
              
          } else if (document.selection && document.selection.type != "Control") {
              console.log("document.selection");
              console.log(document.selection());
              console.log("document.selection.createRange()");
              console.log(document.selection.createRange());
              text = document.selection.createRange().text;
          }
          return text;
      }
      // because firefox has a bug we use this to get highlighted text from a textarea.
      // textarea id required.
      function getSelectionText(id) {
          if (id == null) {
            return getRegularSelectionText();
          }
          var text = "";
          var activeEl = document.getElementById(id);
          var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
          if (
            (activeElTagName == "textarea") || (activeElTagName == "input" &&
            /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
            (typeof activeEl.selectionStart == "number")
          ) {
              text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
          } else if (window.getSelection) {
              text = window.getSelection().toString();
          }
          return text;
      }
      function getSelectedText(ids) {
        var text = getRegularSelectionText();
        if (text == "") {
          for ( i in ids) {
            var id = ids[i];
            text = getSelectionText(id);
            if (text != "") {
              break;
            }
          }
        };
        app.ports.receiveSelectedText.send(text);
      }

      function getTASelection(id) {
          console.log("getTASelection");
          var range = { text: "", offset: null };
          var activeEl = document.getElementById(id);
          var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
          if (
            (activeElTagName == "textarea") || (activeElTagName == "input" &&
            /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
            (typeof activeEl.selectionStart == "number")
          ) {
              console.log("rangin");
              range.text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
              range.offset = activeEl.selectionStart;
              app.ports.receiveTASelection.send(range);
          }
          else {
              app.ports.receiveTASelection.send(null);
          }
      }

      login = {{logindata}};
      errorid = {{errorid}};

      app = Elm.Main.init({
        node: document.getElementById('elm'),
        flags: { seed : Math.floor(Math.random()*0x0FFFFFFF), 
                 location : document.location.origin || "", 
                 useragent : navigator.userAgent, 
                 debugstring : "initial-info", 
                 width : window.innerWidth, 
                 height : window.innerHeight,
                 errorid : errorid,
                 login : login}});
      // local storage
      app.ports.storeLocalVal.subscribe(storeVal);
      app.ports.getLocalVal.subscribe(getVal);
      // app.ports.clearLocalStorage.subscribe(clearStorage);

      // selected text
      app.ports.getSelectedText.subscribe(getSelectedText);
      app.ports.getTASelection.subscribe(getTASelection);
      // keydown events
      app.ports.sendKeyCommand.subscribe(sendKeyCommand);
      window.addEventListener( "keydown", keycheck, false );

    </script>
  </body>
</html>
